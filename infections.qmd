---
title: "Outbreak Magnitude"
description: "Summarize the number of farms and total cattle infected in simulated outbreaks"
format:
  html: 
    df-print: kable
    code-fold: true
    code-summary: "Code"
    code-overflow: wrap
    toc-title: Page Contents
    toc: true
    toc-depth: 2
    toc-location: right
    number-sections: false
    html-math-method: katex
    smooth-scroll: true
editor: source
editor_options: 
  chunk_output_type: console
---

```{=html}
<style type="text/css">

body, td {
   font-size: 13pt;
}
code.r{
  font-size: 9pt;
}
pre {
  font-size: 11pt
}
</style>
```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
options(dplyr.summarise.inform = FALSE)

library(usefun)
library(ggplot2)
library(here)
library(patchwork)
library(scales)

## Custom Functions
source(here("./R/utilities.R"))
source_dir("./R")

## Assign file path 
file_path <- "./script-inputs/isp-outputs"

## Import infection data
infection <- import_infection_data(file_path)

## Order response_type
infection$response_type <- ordered(factor(infection$response_type), c("optimal", "suboptimal", "low-virulence"))

## Order regional_scenarios
infection$regional_scenario <- ordered(factor(infection$regional_scenario), c("central", "eastern"))
```

## Infection Summary
The `summarize_infections()` summarizes infection metrics by iteration. 
```{r}
## Summarize infection metrics for each iteration
infect_summary <- summarize_infections(infection)

## Select and order columns
infect_summary <- infect_summary[c("iteration", "farms_infected", "cattle_infected", "first_infect_day", "last_infect_day", "regional_scenario", "response_type", "preclinical_days")]

## Check data
head(infect_summary, 3)
```

### Summary Statistics
The `generate_infect_statistics()` returns summary statistics grouped by `regional_scenario`, `preclinical_days`, and `response_type`. The `infect_config_summary` can be filtered by `summary` to summarize `farms_infected` or `cattle_infected` across scenarios.
```{r}
infect_config_summary <- generate_infect_statistics(infect_summary)

## Filter to farms
farms_inf_summary <- infect_config_summary %>%    
  filter(summary == "farms_infected")

## Filter to cattle
cattle_inf_summary <- infect_config_summary %>%    
  filter(summary == "cattle_infected")
```

## Infected Farms

::: panel-tabset
## Central U.S.
```{r}
## Filter to central region
farms_central_summary <- farms_inf_summary %>%
  filter(regional_scenario == "central")

## Select and order columns
farms_central_summary <- farms_central_summary[c("mean", "q05", "q25", "q50", "q75", "q95", "response_type", "preclinical_days")]

farms_central_summary
```

## Eastern U.S.
```{r}
## Filter to eastern region
farms_eastern_summary <- farms_inf_summary %>%
  filter(regional_scenario == "eastern")

## Remove extra columns
farms_eastern_summary[3:12]
```

:::

## Total Cattle

::: panel-tabset
## Central U.S.
```{r}
## Filter to central region
cattle_central_summary <- cattle_inf_summary %>%
  filter(regional_scenario == "central")

cattle_central_summary
```

## Eastern U.S.
```{r}
## Filter to eastern region
cattle_eastern_summary <- cattle_inf_summary %>%
  filter(regional_scenario == "eastern")

cattle_eastern_summary
```

:::

## Significance Test
Significance testing performed on optimal and suboptimal responses for each regional scenario independently.

```{r}
## Filter out low virulence scenarios
no_LV <- infection %>%
  filter(response_type != "low-virulence")

no_LV_summary <- summarize_infections(no_LV)
```

::: panel-tabset
## Central U.S.
```{r}
## Filter to central region
no_LV_central_summary <- no_LV_summary %>%
  filter(regional_scenario == "central")

range(no_LV_central_summary$cattle_infected) # high values
plot(density(no_LV_central_summary$cattle_infected)) #long tail

## Log scale to normalize data
range(log(no_LV_central_summary$cattle_infected))
plot(density(log(no_LV_central_summary$cattle_infected)))
```

## Eastern U.S.
```{r}
## Filter to eastern region
no_LV_eastern_summary <- no_LV_summary %>%
  filter(regional_scenario == "eastern")

range(no_LV_eastern_summary$cattle_infected) # high values
plot(density(no_LV_eastern_summary$cattle_infected)) #long tail

## Log scale to normalize data
range(log(no_LV_eastern_summary$cattle_infected))
plot(density(log(no_LV_eastern_summary$cattle_infected)))
```

:::

### Linear Model

::: panel-tabset
## Central U.S.
```{r}
model_central_cattle <- lm(log(cattle_infected) ~ preclinical_days * response_type, 
                       data = no_LV_central_summary)

summary(model_central_cattle)
```

## Eastern U.S.
```{r}
model_eastern_cattle <- lm(log(cattle_infected) ~ preclinical_days * response_type, 
                       data = no_LV_eastern_summary)

summary(model_eastern_cattle)
```

:::

### ANOVA

::: panel-tabset
## Central U.S.
```{r fig.width=12, fig.height=10, message=FALSE, warning=FALSE}
anova(model_central_cattle)
```

## Eastern U.S.
```{r fig.width=12, fig.height=10, message=FALSE, warning=FALSE}
anova(model_eastern_cattle)
```

:::

## Plot Cattle Numbers
```{r, warning=FALSE, message=FALSE, echo=FALSE}
## Assign response_type colors
response_colors <- c("#74add1", "orange2", "red4") 
```

The `plot_infected_cattle` function plots infected cattle by scenario, with the duration of incubation phase transmission on the x-axis and the median number of infected cattle on the y-axis.

::: panel-tabset
## Central U.S.
```{r fig.width=12, fig.height=10, message=FALSE, warning=FALSE}
central_cattle_plot <- plot_infected_cattle(cattle_central_summary, "central")

central_cattle_plot
```

## Eastern U.S.
```{r fig.width=12, fig.height=10, message=FALSE, warning=FALSE}
eastern_cattle_plot <- plot_infected_cattle(cattle_eastern_summary, "eastern")

eastern_cattle_plot
```

:::
